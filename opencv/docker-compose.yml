version: "3.8"

services:
  snapshot:
    build: .
    devices:
      - "/dev/video0:/dev/video0"
    environment:
      - SNAPSHOT_DEVICE=/dev/video0
      - SNAPSHOT_WIDTH=1920
      - SNAPSHOT_HEIGHT=1080
      - SNAPSHOT_FPS=30
      - SNAPSHOT_QUALITY=95
      - SNAPSHOT_INTERVAL=0
    command:
      [
        "python",
        "snapshot_server.py",
        "--device",
        "${SNAPSHOT_DEVICE:-/dev/video0}",
        "--width",
        "${SNAPSHOT_WIDTH:-1920}",
        "--height",
        "${SNAPSHOT_HEIGHT:-1080}",
        "--fps",
        "${SNAPSHOT_FPS:-30}",
        "--quality",
        "${SNAPSHOT_QUALITY:-95}",
        "--interval",
        "${SNAPSHOT_INTERVAL:-0}",
        "--host",
        "0.0.0.0",
        "--port",
        "8081",
      ]

  nginx:
    image: nginx:stable
    ports:
      - "443:443"
    volumes:
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./certs:/etc/nginx/certs:ro
      - ./auth:/etc/nginx/auth:ro
    depends_on:
      - snapshot
